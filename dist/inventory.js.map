{"version":3,"file":"inventory.js","names":[],"sources":["../src/react/queries/inventory/inventory.ts"],"sourcesContent":["import type {\n\tIndexerContractInfo as ContractInfo,\n\tIndexerTokenBalance as TokenBalance,\n} from '@0xsequence/api-client';\nimport type { Address } from 'viem';\nimport type { Page } from '../../../types';\nimport { compareAddress } from '../../../utils';\nimport {\n\tbuildQueryOptions,\n\tContractType,\n\tgetQueryClient,\n\tMetadataStatus,\n\ttype SdkQueryParams,\n\ttype WithOptionalParams,\n\ttype WithRequired,\n} from '../../_internal';\nimport { tokenBalancesOptions } from '../collectible/token-balances';\nimport { fetchMarketplaceConfig } from '../marketplace/config';\n\nexport interface FetchInventoryParams {\n\taccountAddress: Address;\n\tcollectionAddress: Address;\n\tchainId: number;\n\tincludeNonTradable?: boolean;\n\tpage?: number;\n\tpageSize?: number;\n}\n\nexport interface CollectibleWithBalance {\n\tmetadata: {\n\t\ttokenId: bigint;\n\t\tattributes: Array<any>;\n\t\timage?: string;\n\t\tname: string;\n\t\tdescription?: string;\n\t\tvideo?: string;\n\t\taudio?: string;\n\t\tstatus: MetadataStatus;\n\t};\n\tbalance: string;\n\tcontractInfo?: ContractInfo;\n\tcontractType: ContractType.ERC1155 | ContractType.ERC721;\n}\n\nexport interface CollectiblesResponse {\n\tcollectibles: CollectibleWithBalance[];\n\tpage: Page;\n\tisTradable: boolean;\n}\n\n/**\n * Validates if a contract type is a valid collectible type (ERC721 or ERC1155)\n */\nfunction isCollectibleContractType(\n\tcontractType: string,\n): contractType is ContractType.ERC721 | ContractType.ERC1155 {\n\treturn (\n\t\tcontractType === ContractType.ERC721 ||\n\t\tcontractType === ContractType.ERC1155\n\t);\n}\n\n/**\n * Transforms an Indexer token balance into a collectible with metadata\n * @throws Error if token is not a valid collectible type (ERC721/ERC1155)\n */\nfunction collectibleFromTokenBalance(\n\ttoken: TokenBalance,\n): CollectibleWithBalance {\n\tif (!isCollectibleContractType(token.contractType)) {\n\t\tthrow new Error(\n\t\t\t`Invalid collectible type: ${token.contractType}. Only ERC721 and ERC1155 tokens are supported.`,\n\t\t);\n\t}\n\n\treturn {\n\t\tmetadata: {\n\t\t\ttokenId: token.tokenId ?? 0n,\n\t\t\tattributes: token.tokenMetadata?.attributes ?? [],\n\t\t\timage: token.tokenMetadata?.image,\n\t\t\tname: token.tokenMetadata?.name ?? '',\n\t\t\tdescription: token.tokenMetadata?.description,\n\t\t\tvideo: token.tokenMetadata?.video,\n\t\t\taudio: token.tokenMetadata?.audio,\n\t\t\tstatus: MetadataStatus.AVAILABLE,\n\t\t},\n\t\tcontractInfo: token.contractInfo,\n\t\tcontractType: token.contractType,\n\t\tbalance: token.balance.toString(),\n\t};\n}\n\nasync function fetchIndexerTokens(\n\tparams: WithRequired<\n\t\tInventoryQueryOptions,\n\t\t'chainId' | 'accountAddress' | 'collectionAddress' | 'config'\n\t>,\n): Promise<{ collectibles: CollectibleWithBalance[] }> {\n\tconst { chainId, accountAddress, collectionAddress, config } = params;\n\tconst queryClient = getQueryClient();\n\tconst balances = await queryClient.fetchQuery(\n\t\ttokenBalancesOptions({\n\t\t\tcollectionAddress,\n\t\t\tuserAddress: accountAddress,\n\t\t\tchainId,\n\t\t\tincludeMetadata: true,\n\t\t\tconfig,\n\t\t}),\n\t);\n\n\tconst collectibles = balances.map((balance) =>\n\t\tcollectibleFromTokenBalance(balance),\n\t);\n\n\treturn {\n\t\tcollectibles,\n\t};\n}\n\nexport type InventoryQueryOptions = SdkQueryParams<\n\tFetchInventoryParams,\n\t{\n\t\tenabled?: boolean;\n\t}\n>;\n\n/**\n * @deprecated Use InventoryQueryOptions instead\n */\nexport type UseInventoryArgs = Omit<InventoryQueryOptions, 'config'> & {\n\tconfig?: InventoryQueryOptions['config'];\n};\n\nexport async function fetchInventory(\n\tparams: WithRequired<\n\t\tInventoryQueryOptions,\n\t\t'accountAddress' | 'collectionAddress' | 'chainId' | 'config'\n\t>,\n): Promise<CollectiblesResponse> {\n\tconst {\n\t\taccountAddress,\n\t\tcollectionAddress,\n\t\tchainId,\n\t\tconfig,\n\t\tpage = 1,\n\t\tpageSize = 30,\n\t} = params;\n\tconst marketplaceConfig = await fetchMarketplaceConfig({ config });\n\n\tconst marketCollections = marketplaceConfig?.market.collections || [];\n\n\tconst isMarketCollection = marketCollections.some((collection) =>\n\t\tcompareAddress(collection.itemsAddress, collectionAddress),\n\t);\n\n\t// Determine if this collection is tradable (market collection vs shop collection)\n\tconst isTradable = isMarketCollection;\n\n\t// Fetch collectibles from indexer\n\tconst { collectibles } = await fetchIndexerTokens({\n\t\tchainId,\n\t\taccountAddress,\n\t\tcollectionAddress,\n\t\tconfig,\n\t});\n\n\treturn {\n\t\tcollectibles,\n\t\tpage: {\n\t\t\tpage,\n\t\t\tpageSize,\n\t\t},\n\t\tisTradable,\n\t};\n}\n\nexport function getInventoryQueryKey(params: InventoryQueryOptions) {\n\treturn [\n\t\t'inventory',\n\t\tparams.accountAddress,\n\t\tparams.collectionAddress,\n\t\tparams.chainId,\n\t\tparams.page ?? 1,\n\t\tparams.pageSize ?? 30,\n\t] as const;\n}\n\nexport function inventoryOptions(\n\tparams: WithOptionalParams<\n\t\tWithRequired<\n\t\t\tInventoryQueryOptions,\n\t\t\t'accountAddress' | 'collectionAddress' | 'chainId' | 'config'\n\t\t>\n\t>,\n) {\n\treturn buildQueryOptions(\n\t\t{\n\t\t\tgetQueryKey: getInventoryQueryKey,\n\t\t\trequiredParams: [\n\t\t\t\t'accountAddress',\n\t\t\t\t'collectionAddress',\n\t\t\t\t'chainId',\n\t\t\t\t'config',\n\t\t\t] as const,\n\t\t\tfetcher: fetchInventory,\n\t\t},\n\t\tparams,\n\t);\n}\n"],"mappings":";;;;;;;;;;AAqDA,SAAS,0BACR,cAC6D;AAC7D,QACC,iBAAiB,aAAa,UAC9B,iBAAiB,aAAa;;;;;;AAQhC,SAAS,4BACR,OACyB;AACzB,KAAI,CAAC,0BAA0B,MAAM,aAAa,CACjD,OAAM,IAAI,MACT,6BAA6B,MAAM,aAAa,iDAChD;AAGF,QAAO;EACN,UAAU;GACT,SAAS,MAAM,WAAW;GAC1B,YAAY,MAAM,eAAe,cAAc,EAAE;GACjD,OAAO,MAAM,eAAe;GAC5B,MAAM,MAAM,eAAe,QAAQ;GACnC,aAAa,MAAM,eAAe;GAClC,OAAO,MAAM,eAAe;GAC5B,OAAO,MAAM,eAAe;GAC5B,QAAQ,eAAe;GACvB;EACD,cAAc,MAAM;EACpB,cAAc,MAAM;EACpB,SAAS,MAAM,QAAQ,UAAU;EACjC;;AAGF,eAAe,mBACd,QAIsD;CACtD,MAAM,EAAE,SAAS,gBAAgB,mBAAmB,WAAW;AAgB/D,QAAO,EACN,eAfgB,MADG,gBAAgB,CACD,WAClC,qBAAqB;EACpB;EACA,aAAa;EACb;EACA,iBAAiB;EACjB;EACA,CAAC,CACF,EAE6B,KAAK,YAClC,4BAA4B,QAAQ,CACpC,EAIA;;AAiBF,eAAsB,eACrB,QAIgC;CAChC,MAAM,EACL,gBACA,mBACA,SACA,QACA,OAAO,GACP,WAAW,OACR;CAUJ,MAAM,eAToB,MAAM,uBAAuB,EAAE,QAAQ,CAAC,GAErB,OAAO,eAAe,EAAE,EAExB,MAAM,eAClD,eAAe,WAAW,cAAc,kBAAkB,CAC1D;CAMD,MAAM,EAAE,iBAAiB,MAAM,mBAAmB;EACjD;EACA;EACA;EACA;EACA,CAAC;AAEF,QAAO;EACN;EACA,MAAM;GACL;GACA;GACA;EACD;EACA;;AAGF,SAAgB,qBAAqB,QAA+B;AACnE,QAAO;EACN;EACA,OAAO;EACP,OAAO;EACP,OAAO;EACP,OAAO,QAAQ;EACf,OAAO,YAAY;EACnB;;AAGF,SAAgB,iBACf,QAMC;AACD,QAAO,kBACN;EACC,aAAa;EACb,gBAAgB;GACf;GACA;GACA;GACA;GACA;EACD,SAAS;EACT,EACD,OACA"}